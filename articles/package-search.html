<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>How objects are found by package functions • environments</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="How objects are found by package functions">
<meta property="og:description" content="environments">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">environments</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.3.0-9009</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/package-search.html">How objects are found by package functions</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>How objects are found by package functions</h1>
                        <h4 data-toc-skip class="author">Henrik
Bengtsson</h4>
            
      
      
      <div class="hidden name"><code>package-search.md</code></div>

    </div>

    
    
<!--
%\VignetteIndexEntry{How objects are found by package functions}
%\VignetteAuthor{Henrik Bengtsson}
%\VignetteKeyword{R}
%\VignetteKeyword{package}
%\VignetteKeyword{vignette}
%\VignetteKeyword{search}
%\VignetteKeyword{namespace}
%\VignetteKeyword{imports}
%\VignetteEngine{environments::selfonly}
-->
<div class="section level3">
<h3 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h3>
<p>Consider a package <strong>teeny</strong> that exports function
<code>mean_and_variance()</code> for calculating the sample mean and the
sample variance in a single call:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Calculate the Mean and Variance</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @param x A numeric vector.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return</span></span>
<span><span class="co">#' A named numeric vector of length two</span></span>
<span><span class="co">#' with elements `mean` and `variance`.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @importFrom stats var</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">mean_and_variance</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="va">sigma2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="va">mu</span>, variance <span class="op">=</span> <span class="va">sigma2</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>There are a few things to notice about the implements. The first is
that we declare that <code>variance()</code> should be imported from the
<strong>stats</strong> package. Here we use a <strong><a href="https://cran.r-project.org/package=roxygen2" class="external-link">roxygen2</a></strong>
<code>@importFrom stats var</code> statement to declare this import,
which is short for manually adding an
<code>importFrom(stats, var)</code> entry in the package
<code>NAMESPACE</code> file.</p>
<p>The second is that, because all objects exported by the
<strong>base</strong> package are always available, we do not have to
explicitly import them. It is actually not possible to import
<strong>base</strong> functions; if we would add an
<code>@importFrom base mean</code> statement, the package fails to
<em>install</em> (see Appendix).</p>
<p>Continuing, when R evaluates</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">teeny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/teeny/man/mean_and_variance.html" class="external-link">mean_and_variance</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="co">#&gt;     mean variance </span></span>
<span><span class="co">#&gt;  50.5000 841.6667</span></span></code></pre></div>
<p>it will eventually have to locate functions <code><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean()</a></code> and
<code><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var()</a></code>. It turns out that these are effectively found
as:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pkg_ns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-reflect.html" class="external-link">getNamespace</a></span><span class="op">(</span><span class="st">"teeny"</span><span class="op">)</span></span>
<span><span class="va">mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">parent.env</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">parent.env</a></span><span class="op">(</span><span class="va">pkg_ns</span><span class="op">)</span><span class="op">)</span><span class="op">[[</span><span class="st">"mean"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">var</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">parent.env</a></span><span class="op">(</span>           <span class="va">pkg_ns</span> <span class="op">)</span><span class="op">[[</span><span class="st">"var"</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p>Note the extra layer of <code><a href="https://rdrr.io/r/base/environment.html" class="external-link">parent.env()</a></code> for
<code><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean()</a></code>. So, why are they not found in the same environment?
This is because we explicitly imported <code><a href="https://rdrr.io/r/stats/cor.html" class="external-link">stats::var()</a></code>, but
not <code><a href="https://rdrr.io/r/base/mean.html" class="external-link">base::mean()</a></code>.</p>
<p>Let’s dig in deeper to see how this works, but before doing that,
let’s look at what the parent environments of the <strong>teeny</strong>
namespace are. We can du this using the <strong>environments</strong>
package as:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pkg_ns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-reflect.html" class="external-link">getNamespace</a></span><span class="op">(</span><span class="st">"teeny"</span><span class="op">)</span></span>
<span><span class="va">nss</span> <span class="op">&lt;-</span> <span class="fu">environments</span><span class="fu">::</span><span class="fu"><a href="../reference/parent_envs.html">parent_envs</a></span><span class="op">(</span><span class="va">pkg_ns</span><span class="op">)</span></span>
<span><span class="va">nss</span></span>
<span><span class="co">#&gt; $teeny</span></span>
<span><span class="co">#&gt; &lt;environment: namespace:teeny&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`imports:teeny`</span></span>
<span><span class="co">#&gt; &lt;environment: 0x55cb372dd980&gt;</span></span>
<span><span class="co">#&gt; attr(,"name")</span></span>
<span><span class="co">#&gt; [1] "imports:teeny"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $base</span></span>
<span><span class="co">#&gt; &lt;environment: namespace:base&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $R_GlobalEnv</span></span>
<span><span class="co">#&gt; &lt;environment: R_GlobalEnv&gt;</span></span></code></pre></div>
<p>This reveals (part of) the search path used by the functions in the
<strong>teeny</strong> package. When <code>mean_and_variance()</code> is
called, R searches for <code><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean()</a></code> and <code><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var()</a></code> in
these environments until found. So, in the case of <code><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean()</a></code>,
it first looks <code>nss[[1]]</code> using something like
<code>exists("mean", mode = "function", envir = nss[[1]], inherits = FALSE)</code>,
and if not found, it continues to environment <code>nss[[2]]</code>, and
so on until found. In this case, it locates <code><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean()</a></code> in
<code>nss[[3]]</code>, i.e. in the <strong>base</strong> namespace;</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span><span class="st">"mean"</span>, mode <span class="op">=</span> <span class="st">"function"</span>, envir <span class="op">=</span> <span class="va">nss</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span>, inherits <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>It searches for <code><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var()</a></code> in a similar manner. Since
<code><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var()</a></code> was explicitly imported, and all package imports are
stored in the <code>imports::teeny</code> environment, it finds
<code><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var()</a></code> in <code>nss[[2]]</code>;</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/exists.html" class="external-link">exists</a></span><span class="op">(</span><span class="st">"var"</span>, mode <span class="op">=</span> <span class="st">"function"</span>, envir <span class="op">=</span> <span class="va">nss</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, inherits <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p>This begs the question, isn’t that imported <code><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var()</a></code>
function a copy of the <code><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var()</a></code> in the <strong>stats</strong>
package? Yes, it is! Technically, we could, with some hacks, replace the
“imported” <code><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var()</a></code> with another function after the package
has been loaded.</p>
</div>
<div class="section level3">
<h3 id="forgetting-to-import-a-function">Forgetting to import a function<a class="anchor" aria-label="anchor" href="#forgetting-to-import-a-function"></a>
</h3>
<p>Now, what would happen if we forget to import
<code><a href="https://rdrr.io/r/stats/cor.html" class="external-link">stats::var()</a></code>? Let’s retry by dropping:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @importFrom stats var</span></span></code></pre></div>
<p>First of all, <code>R CMD check</code> would detect this and produce
the following NOTE:</p>
<pre><code>* checking R code for possible problems ... NOTE
mean_and_variance: no visible global function definition for ‘var’
Undefined global functions or variables:
  var
Consider adding
  importFrom("stats", "var")
to your NAMESPACE file.</code></pre>
<p>That’s conforting to know. Note also how it suggests how we might be
able to resolve it. That is a useful service.</p>
<p>Next, let’s see what happens if we try to use the function;</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">teeny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/teeny/man/mean_and_variance.html" class="external-link">mean_and_variance</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="co">#&gt;     mean variance </span></span>
<span><span class="co">#&gt;  50.5000 841.6667</span></span></code></pre></div>
<p>Hmm, how is that possible? The <code><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var()</a></code> function does not
exist in the package namespace, not in the “imports” environments, not
in the <strong>base</strong> namespace, and not in the global
environment. What we didn’t say above is that, if a function cannot be
found even in the global environment, it continues to search the parent
environments of the global environment too. The parent environments of
the global environment are all the environments that
<code><a href="https://rdrr.io/r/base/search.html" class="external-link">search()</a></code> reports;</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">search</span>()</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">".GlobalEnv"</span>        <span class="st">"package:stats"</span>     <span class="st">"package:graphics"</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>[<span class="dv">4</span>] <span class="st">"package:grDevices"</span> <span class="st">"package:utils"</span>     <span class="st">"package:datasets"</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>[<span class="dv">7</span>] <span class="st">"package:methods"</span>   <span class="st">"Autoloads"</span>         <span class="st">"package:base"</span></span></code></pre></div>
<p>If the object search for is not found in one of these environments,
then it ends up at the very top parent environment, which is always the
empty environment, and stops there (with an error).</p>
<p>To see <em>all</em> the environment searched, we can use:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pkg_ns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-reflect.html" class="external-link">getNamespace</a></span><span class="op">(</span><span class="st">"teeny"</span><span class="op">)</span></span>
<span><span class="va">nss</span> <span class="op">&lt;-</span> <span class="fu">environments</span><span class="fu">::</span><span class="fu"><a href="../reference/parent_envs.html">parent_envs</a></span><span class="op">(</span><span class="va">pkg_ns</span>, until <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">emptyenv</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">nss</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 13</span></span>
<span><span class="co">#&gt;  $ teeny            :&lt;environment: namespace:teeny&gt; </span></span>
<span><span class="co">#&gt;  $ imports:teeny    :&lt;environment: 0x555840d33fc8&gt; </span></span>
<span><span class="co">#&gt;   ..- attr(*, "name")= chr "imports:teeny"</span></span>
<span><span class="co">#&gt;  $ base             :&lt;environment: namespace:base&gt; </span></span>
<span><span class="co">#&gt;  $ R_GlobalEnv      :&lt;environment: R_GlobalEnv&gt; </span></span>
<span><span class="co">#&gt;  $ package:stats    :&lt;environment: package:stats&gt; </span></span>
<span><span class="co">#&gt;   ..- attr(*, "name")= chr "package:stats"</span></span>
<span><span class="co">#&gt;   ..- attr(*, "path")= chr "/home/hb/shared/software/CBI/R-4.2.1-gcc9/lib/R/library/stats"</span></span>
<span><span class="co">#&gt;  $ package:graphics :&lt;environment: package:graphics&gt; </span></span>
<span><span class="co">#&gt;   ..- attr(*, "name")= chr "package:graphics"</span></span>
<span><span class="co">#&gt;   ..- attr(*, "path")= chr "/home/hb/shared/software/CBI/R-4.2.1-gcc9/lib/R/library/graphics"</span></span>
<span><span class="co">#&gt;  $ package:grDevices:&lt;environment: package:grDevices&gt; </span></span>
<span><span class="co">#&gt;   ..- attr(*, "name")= chr "package:grDevices"</span></span>
<span><span class="co">#&gt;   ..- attr(*, "path")= chr "/home/hb/shared/software/CBI/R-4.2.1-gcc9/lib/R/library/grDevices"</span></span>
<span><span class="co">#&gt;  $ package:utils    :&lt;environment: package:utils&gt; </span></span>
<span><span class="co">#&gt;   ..- attr(*, "name")= chr "package:utils"</span></span>
<span><span class="co">#&gt;   ..- attr(*, "path")= chr "/home/hb/shared/software/CBI/R-4.2.1-gcc9/lib/R/library/utils"</span></span>
<span><span class="co">#&gt;  $ package:datasets :&lt;environment: package:datasets&gt; </span></span>
<span><span class="co">#&gt;   ..- attr(*, "name")= chr "package:datasets"</span></span>
<span><span class="co">#&gt;   ..- attr(*, "path")= chr "/home/hb/shared/software/CBI/R-4.2.1-gcc9/lib/R/library/datasets"</span></span>
<span><span class="co">#&gt;  $ package:methods  :&lt;environment: package:methods&gt; </span></span>
<span><span class="co">#&gt;   ..- attr(*, "name")= chr "package:methods"</span></span>
<span><span class="co">#&gt;   ..- attr(*, "path")= chr "/home/hb/shared/software/CBI/R-4.2.1-gcc9/lib/R/library/methods"</span></span>
<span><span class="co">#&gt;  $ Autoloads        :&lt;environment: 0x55583eee63c0&gt; </span></span>
<span><span class="co">#&gt;   ..- attr(*, "name")= chr "Autoloads"</span></span>
<span><span class="co">#&gt;  $ base             :&lt;environment: base&gt; </span></span>
<span><span class="co">#&gt;  $ R_EmptyEnv       :&lt;environment: R_EmptyEnv&gt;</span></span></code></pre></div>
<p>Thus, the reason why <code>teeny::mean_and_variance(1:100)</code>
works, is that R eventually locates <code><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var()</a></code> in the
<strong>stats</strong> package, i.e. in the <code>package:stats</code>
environment. Using the <strong>environments</strong> package, we can see
where it finds <code><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var()</a></code> by calling:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">environments</span><span class="fu">::</span><span class="fu"><a href="../reference/find_object.html">find_object</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"var"</span>, from <span class="op">=</span> <span class="fu">teeny</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/teeny/man/mean_and_variance.html" class="external-link">mean_and_variance</a></span><span class="op">)</span></span>
<span><span class="co"># &gt; $name</span></span>
<span><span class="co"># &gt; [1] "var"</span></span>
<span><span class="co"># &gt; </span></span>
<span><span class="co"># &gt; $envir</span></span>
<span><span class="co"># &gt; &lt;environment: package:stats&gt;</span></span>
<span><span class="co"># &gt; attr(,"name")</span></span>
<span><span class="co"># &gt; [1] "package:stats"</span></span>
<span><span class="co"># &gt; attr(,"path")</span></span>
<span><span class="co">#&gt; [1] "/home/hb/shared/software/CBI/R-4.2.1-gcc9/lib/R/library/stats"</span></span></code></pre></div>
<p>So, why do we even bother to import <code><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var()</a></code> from the
<strong>stats</strong> package then? Recall how also the global
environment is part of the search path. This means that we can inject
another, possible false, implementation of <code><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var()</a></code> by adding
it to the global environment, e.g.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">var</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">pi</span></span>
<span><span class="fu">teeny</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/teeny/man/mean_and_variance.html" class="external-link">mean_and_variance</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="co">#&gt;      mean  variance </span></span>
<span><span class="co">#&gt; 50.500000  3.141593</span></span></code></pre></div>
<p>Whoops! That’s really worrying; the result of the function depends on
what happens to be in the global environment of the current R session.
Futhermore, the <strong>stats</strong> package may not even be attached,
so we could end up with an error also a fresh R session, e.g.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span> R_DEFAULT_PACKAGES<span class="ot">=</span>base R <span class="sc">--</span>quiet <span class="sc">--</span>vanilla</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">search</span>()</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">".GlobalEnv"</span>   <span class="st">"Autoloads"</span>    <span class="st">"package:base"</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> teeny<span class="sc">::</span><span class="fu">mean_and_variance</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>Error <span class="cf">in</span> <span class="fu">var</span>(x) <span class="sc">:</span> could not find <span class="cf">function</span> <span class="st">"var"</span></span></code></pre></div>
<p>This illustrates why it is important to declare <em>all</em> imports,
even those from base-R packages. So, do <em>not</em> ignore those NOTEs
on “no visible global function definition for …” that
<code>R CMD check</code> reports on.</p>
</div>
<div class="section level3">
<h3 id="why-r-searches-also-the-global-environment-and-attached-packages">Why R searches also the global environment and attached
packages<a class="anchor" aria-label="anchor" href="#why-r-searches-also-the-global-environment-and-attached-packages"></a>
</h3>
<p>The parent environment of the <strong>base</strong> namespace is the
global environment;</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">base_ns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-reflect.html" class="external-link">getNamespace</a></span><span class="op">(</span><span class="st">"base"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/parent_envs.html">parent_envs</a></span><span class="op">(</span><span class="va">base_ns</span><span class="op">)</span></span>
<span><span class="co">#&gt; $base</span></span>
<span><span class="co">#&gt; &lt;environment: namespace:base&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $R_GlobalEnv</span></span>
<span><span class="co">#&gt; &lt;environment: R_GlobalEnv&gt;</span></span></code></pre></div>
<p>So, why isn’t it just the empty environment? Then we would avoid the
problem of picking up unwanted objects in the global environment, and
avoid being dependent on what packages happens to be attached at the
time we call our package functions.<br>
The answer has to do with historical reasons. The design of having the
<strong>base</strong> namespace being followed by the global environment
stems from the old days when R did not have namespaces. At that time,
the R engine searched all attached packages to identify any variable or
function used to evaluate a function. That design had of course similar
problems to the ones illustrated above, e.g. functions could be
overridden by assign new ones in the global environment, or by a
third-party package attached on the <code><a href="https://rdrr.io/r/base/search.html" class="external-link">search()</a></code> path. This is
why the concept of <em>namespaces</em> was introduced in R; as a package
developer you had full control of exactly which implementation of a
function was called.</p>
<p>However, due to how S3 method dispatching worked, and how some
packages attaches packages conditionally of being available,
e.g. <code>if require(otherpkg)) somefcn()</code>, it was necessary to
keep searching also the global environment and attached packages as a
fallback. These are the main reasons why the <strong>base</strong>
namespace is still followed by the global environment. It is not
unreasonable to expect that this will change in some future R version.
For instance, in the R-devel thread ‘Time to drop globalenv() from
searches in package code?’ (2022-09-15; <a href="https://stat.ethz.ch/pipermail/r-devel/2022-September/081980.html" class="external-link uri">https://stat.ethz.ch/pipermail/r-devel/2022-September/081980.html</a>),
one of the R Core developers explains the history and proposes a way
forward to make the empty environment the parent of the
<strong>base</strong> namespace.</p>
</div>
<div class="section level2">
<h2 id="appendix">Appendix<a class="anchor" aria-label="anchor" href="#appendix"></a>
</h2>
<div class="section level3">
<h3 id="it-is-not-possible-to-import-from-the-base-package">It is not possible to import from the ‘base’ package<a class="anchor" aria-label="anchor" href="#it-is-not-possible-to-import-from-the-base-package"></a>
</h3>
<p>If we would add:</p>
<pre><code><span><span class="fu">importFrom</span><span class="op">(</span><span class="va">base</span>, <span class="va">mean</span><span class="op">)</span></span></code></pre>
<p>to the <code>NAMESPACE</code> file for <strong>teeny</strong>, the
package would build, but it would not <em>install</em>. We would get an
installation error:</p>
<pre><code>$ R CMD INSTALL teeny_0_1.0.tar.gz 
* installing to library ‘/home/hb/R/x86_64-pc-linux-gnu-library/4.2-CBI-gcc9’
* installing *source* package ‘teeny’ ...
** using staged installation
** R
** byte-compile and prepare package for lazy loading
Error in asNamespace(ns, base.OK = FALSE) : 
  operation not allowed on base namespace
Calls: &lt;Anonymous&gt; ... namespaceImportFrom -&gt; importIntoEnv -&gt; getNamespaceInfo -&gt; asNamespace
ERROR: lazy loading failed for package ‘teeny’
* removing ‘/home/hb/R/x86_64-pc-linux-gnu-library/4.2-CBI-gcc9/teeny’
* restoring previous ‘/home/hb/R/x86_64-pc-linux-gnu-library/4.2-CBI-gcc9/teeny’</code></pre>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Henrik Bengtsson.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6</p> and <a href="https://github.com/HenrikBengtsson/pkgdown.extras/">pkgdown.extras</a> 0.0.0.9004.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
